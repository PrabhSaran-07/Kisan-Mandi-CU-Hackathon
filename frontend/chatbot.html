<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - Kisan Mandi</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- Navigation -->
<nav>
    <div class="navbar">
        <a href="/" class="logo">Kisan Mandi</a>
        <ul class="nav-links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="marketplace.html">Marketplace</a></li>
            <li><a href="chatbot.html">AI Chatbot</a></li>
            <li><a href="prices.html">Prices</a></li>
            <li id="userGreeting" style="color:#2ecc71;"></li>
            <li><button class="btn-logout" onclick="logout()">Logout</button></li>
        </ul>
    </div>
</nav>

<div class="container">
    <div style="max-width:700px;margin:auto;">

        <div class="card">
            <div class="card-header">AI Agricultural Advisor</div>
            <p>Ask about crop prices, best harvest season, or farming tips.</p>
        </div>

        <!-- Chat Box -->
            <div class="chat-wrapper" style="display:flex;flex-direction:column;height:600px;">

            <div id="chatMessages" class="chat-messages">
            </div>

            <div class="chat-controls">
                <input id="userInput" class="input-field" type="text" placeholder="Ask something..."
                       onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="btn btn-primary btn-floating" onclick="sendMessage()">Send</button>
            </div>

            <div id="loadingIndicator" style="display:none;text-align:center;color:#888;margin-top:1rem;">
                AI is thinking...
            </div>
        </div>

        <!-- Quick Questions -->
        <div class="card">
            <h3>Quick Questions</h3>
            <button class="btn btn-secondary" onclick="askQuick('current wheat price')">Current wheat price</button>
            <button class="btn btn-secondary" onclick="askQuick('best season to harvest wheat')">Best season to harvest wheat</button>
            <button class="btn btn-secondary" onclick="askQuick('how to sell crops')">How to sell crops</button>
        </div>

    </div>
</div>

<footer>
    <p>&copy; 2026 Kisan Mandi</p>
</footer>

<script>
const API_BASE = "http://localhost:5000/api";
let currentUser = null;

// INIT
function initChatbot() {
    const userStr = localStorage.getItem("user");
    if (!userStr) {
        window.location.href = "login.html";
        return;
    }
    currentUser = JSON.parse(userStr);
    document.getElementById("userGreeting").textContent = currentUser.username;

    addMessage("bot",
        " Hello! I can help with:\n" +
        "• Current crop prices\n" +
        "• Best harvest season\n" +
        "• Selling crops\n\n" +
        "Try: 'current wheat price'"
    );
}

// MESSAGE UI
function addMessage(sender, text) {
    const div = document.createElement("div");
    div.className = 'message ' + (sender === 'user' ? 'user' : 'bot');
    div.textContent = text;
    document.getElementById("chatMessages").appendChild(div);
    // scroll to bottom smoothly
    const chat = document.getElementById("chatMessages");
    chat.scrollTop = chat.scrollHeight;
}

// SEND MESSAGE
async function sendMessage() {
    const input = document.getElementById("userInput");
    const msg = input.value.trim();
    if (!msg) return;

    addMessage("user", msg);
    input.value = "";
    document.getElementById("loadingIndicator").style.display = "block";

    const message = msg.toLowerCase();

    // PRICE QUERY
    if (message.includes("price") || message.includes("rate")) {
        const crop = getCrop(message);
        if (crop) {
            await fetchPrice(crop);
            return;
        }
    }

    // HARVEST QUERY
    if (message.includes("harvest") || message.includes("season")) {
        addMessage("bot", getHarvestAdvice(message));
        document.getElementById("loadingIndicator").style.display = "none";
        return;
    }

    // SELLING
    if (message.includes("sell")) {
        addMessage("bot",
            " How to sell crops:\n" +
            "1. Login as Farmer\n" +
            "2. Go to Marketplace\n" +
            "3. Add crop details\n" +
            "4. Set price & quantity\n" +
            "5. Buyers contact you directly"
        );
        document.getElementById("loadingIndicator").style.display = "none";
        return;
    }

    // For other queries, forward to backend AI/chat endpoint
    try {
        const res = await fetch(`${API_BASE}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ message: msg, type: 'general' })
        });

        if (res.ok) {
            const data = await res.json();
            addMessage('bot', data.bot_response || "I didn't get a response.");
        } else {
            // Fallback message when backend fails
            addMessage("bot",
                "I didn’t understand that.\nTry:\n• current wheat price\n• best season to harvest wheat"
            );
        }
    } catch (e) {
        addMessage('bot', 'Error contacting chat service.');
    }
    document.getElementById("loadingIndicator").style.display = "none";
}

// FETCH PRICE
async function fetchPrice(crop) {
    try {
        const res = await fetch(`${API_BASE}/prices`);
        const prices = await res.json();
        const matches = prices.filter(p => p.crop_name.toLowerCase() === crop);

        if (matches.length === 0) {
            addMessage("bot", `No price data for ${crop}.`);
        } else {
            let reply = ` ${crop.toUpperCase()} Prices:\n`;
            matches.forEach(p => {
                reply += `${p.location}: ₹${p.price}/quintal\n`;
            });
            addMessage("bot", reply);
        }
    } catch {
        addMessage("bot", "Error fetching prices.");
    }
    document.getElementById("loadingIndicator").style.display = "none";
}

// CROP DETECTOR
function getCrop(msg) {
    const crops = ["wheat","rice","cotton","sugarcane","tomato"];
    return crops.find(c => msg.includes(c));
}

// HARVEST INFO
function getHarvestAdvice(msg) {
    if (msg.includes("wheat")) {
        return " Wheat Harvest (India):\n\n" +
               "• Best time: March – April\n" +
               "• Weather: Dry & warm\n" +
               "• Avoid rainfall\n\n" +
               "This gives best quality & price.";
    }
    return "Harvest during dry weather when market demand is high.";
}

// QUICK ASK
function askQuick(q) {
    document.getElementById("userInput").value = q;
    sendMessage();
}

// LOGOUT
function logout() {
    localStorage.removeItem("user");
    window.location.href = "login.html";
}

initChatbot();
</script>

</body>
</html>