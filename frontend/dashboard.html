<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Kisan Mandi</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="navbar">
            <a href="/" class="logo"> Kisan Mandi</a>
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="marketplace.html">Marketplace</a></li>
                <li><a href="chatbot.html">AI Chatbot</a></li>
                <li><a href="advisor.html">AI Advisor</a></li>
                <li><a href="prices.html">Prices</a></li>
                <li id="userGreeting" style="color: #2ecc71;"></li>
                <li><button class="btn-logout" onclick="logout()">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Header -->
        <div class="card">
            <div class="card-header">welcome to Kisan Mandi</div>
            <p>A digital marketplace connecting farmers, buyers, and logistics providers.</p>
        </div>

        <div id="alertContainer"></div>

        <!-- Role-based Content -->
        <div id="farmerSection">
            <div class="card">
                <div class="card-header"> Farmer Dashboard</div>
                <p>Manage your crop listings and transactions.</p>

                <button class="btn btn-primary" onclick="openListCropModal()">+ List New Crop</button>
                <button class="btn btn-secondary" onclick="viewMyListings()">View My Listings</button>
            </div>

            <div id="myListingsContainer"></div>
        </div>

        <div id="buyerSection" style="display: none;">
            <div class="card">
                <div class="card-header"> Buyer Dashboard</div>
                <p>Browse and purchase crops from farmers.</p>

                <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">Browse Marketplace</button>
                <button class="btn btn-secondary" onclick="viewMyOrders()">View My Orders</button>
            </div>

            <div id="myOrdersContainer"></div>
        </div>

        <div id="adminSection" style="display: none;">
            <div class="card">
                <div class="card-header"> Admin Dashboard</div>
                <p>Manage the platform.</p>

                <button class="btn btn-primary" onclick="viewAllUsers()">View All Users</button>
                <button class="btn btn-secondary" onclick="viewAllTransactions()">View All Transactions</button>
                <button class="btn btn-secondary" onclick="managePrices()">Manage Prices</button>
            </div>

            <div id="adminDataContainer"></div>
        </div>

        <!-- General Statistics -->
        <div class="grid">
            <div class="card">
                <div class="card-header"> Platform Stats</div>
                <p>Total Listings: <strong id="totalListings">0</strong></p>
                <p>Total Users: <strong id="totalUsers">0</strong></p>
                <p>Active Transactions: <strong id="activeTransactions">0</strong></p>
            </div>

            <div class="card">
                <div class="card-header"> Quick Links</div>
                <ul style="list-style: none;">
                    <li><a href="marketplace.html" style="color: #2ecc71; text-decoration: none;">â†’ Browse Marketplace</a></li>
                    <li><a href="chatbot.html" style="color: #2ecc71; text-decoration: none;">â†’ Chat with AI Advisor</a></li>
                    <li><a href="prices.html" style="color: #2ecc71; text-decoration: none;">â†’ Check Crop Prices</a></li>
                    <li><a href="#" onclick="viewAgreement(); return false;" style="color: #2ecc71; text-decoration: none;">â†’ View Terms & Agreement</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- List Crop Modal -->
    <div id="listCropModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeListCropModal()">&times;</span>
            <h2>List New Crop</h2>
            
            <form id="listCropForm">
                <div class="form-group">
                    <label>Crop Name</label>
                    <input type="text" id="cropName" required>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="cropCategory" required>
                        <option value="">Select Category</option>
                        <option value="cereal">Cereal (Rice, Wheat)</option>
                        <option value="vegetable">Vegetables</option>
                        <option value="spice">Spices</option>
                        <option value="fruit">Fruits</option>
                        <option value="cash_crop">Cash Crop</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quantity (in KG)</label>
                    <input type="number" id="cropQuantity" step="0.1" required>
                </div>

                <div class="form-group">
                    <label>Price Per Unit (â‚¹/KG)</label>
                    <input type="number" id="cropPrice" step="0.1" required>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="cropDescription" rows="3" placeholder="Describe your crop quality, farming method, etc."></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">List Crop</button>
            </form>
        </div>
    </div>

    <!-- Agreement Modal -->
    <div id="agreementModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <span class="close-modal" onclick="closeAgreement()">&times;</span>
            <h2>Terms & Agreement</h2>
            
            <h3>Platform Agreement - Kisan Mandi</h3>
            <p><strong>Effective Date:</strong> February 2026</p>

            <h4>1. Platform Overview</h4>
            <p>Kisan Mandi is a digital agricultural marketplace connecting farmers, buyers, and logistics providers directly, eliminating middlemen.</p>

            <h4>2. User Responsibilities</h4>
            <ul>
                <li>Farmers: Provide accurate crop information, quality standards</li>
                <li>Buyers: Make legitimate purchases, honest reviews</li>
                <li>All: Maintain authentic identity verification</li>
            </ul>

            <h4>3. Payment & Transactions</h4>
            <p>Payments processed through Razorpay (UPI, Cards). Platform holds 2% transaction fee.</p>

            <h4>4. Dispute Resolution</h4>
            <p>30-day return policy for system errors. Disputes resolved by admin team within 7 days.</p>

            <h4>5. Identity Verification</h4>
            <p>Aadhar or Government ID required for all users. Verification is mandatory.</p>

            <h4>6. Returning Policy</h4>
            <p>If system errors occur in payment or delivery, buyers can return goods within 30 days with proof.</p>

            <h4>7. Data Privacy</h4>
            <p>User data is protected and not shared with third parties except logistics providers for delivery.</p>

            <div style="margin-top: 2rem;">
                <button class="btn btn-primary" onclick="acceptAgreement()">I Agree</button>
                <button class="btn btn-secondary" onclick="closeAgreement()">Close</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 Kisan Mandi. All rights reserved. | Digital Agriculture Marketplace</p>
    </footer>

    <script src="js/app.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentUser = null;

        // Initialize Dashboard
        async function initDashboard() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userStr);
            document.getElementById('userGreeting').textContent = `ðŸ‘¤ ${currentUser.username}`;

            // Show role-specific dashboard
            document.getElementById('farmerSection').style.display = 
                currentUser.role === 'farmer' ? 'block' : 'none';
            document.getElementById('buyerSection').style.display = 
                currentUser.role === 'buyer' ? 'block' : 'none';
            document.getElementById('adminSection').style.display = 
                currentUser.role === 'admin' ? 'block' : 'none';

            if (currentUser.role === 'farmer') {
                viewMyListings();
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        function openListCropModal() {
            document.getElementById('listCropModal').classList.add('show');
        }

        function closeListCropModal() {
            document.getElementById('listCropModal').classList.remove('show');
            document.getElementById('listCropForm').reset();
        }

        function viewAgreement() {
            document.getElementById('agreementModal').classList.add('show');
        }

        function closeAgreement() {
            document.getElementById('agreementModal').classList.remove('show');
        }

        function acceptAgreement() {
            showAlert('Agreement accepted!', 'success');
            closeAgreement();
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('alertContainer');
            alertDiv.innerHTML = `<div class="alert alert-${type} show">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // List Crop Form
        document.getElementById('listCropForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const cropData = {
                crop_name: document.getElementById('cropName').value,
                category: document.getElementById('cropCategory').value,
                quantity: parseFloat(document.getElementById('cropQuantity').value),
                price_per_unit: parseFloat(document.getElementById('cropPrice').value),
                description: document.getElementById('cropDescription').value,
                unit: 'kg'
            };

            try {
                const response = await fetch(`${API_BASE}/crops`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(cropData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Crop listed successfully!', 'success');
                    closeListCropModal();
                    viewMyListings();
                } else {
                    showAlert(data.error || 'Failed to list crop', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        // View My Listings
        async function viewMyListings() {
            try {
                const response = await fetch(`${API_BASE}/crops`, {
                    credentials: 'include'
                });
                const crops = await response.json();

                // Filter crops by current farmer
                const myCrops = crops.filter(crop => crop.seller.id === currentUser.id);

                let html = '<div class="card"><div class="card-header">My Crops Listed</div>';
                if (myCrops.length === 0) {
                    html += '<p>No crops listed yet.</p>';
                } else {
                    html += '<div class="grid">';
                    myCrops.forEach(crop => {
                        html += `
                            <div class="crop-card">
                                <div class="crop-image">ðŸŒ¾</div>
                                <div class="crop-info">
                                    <div class="crop-name">${crop.crop_name}</div>
                                    <div class="crop-price">â‚¹${crop.price_per_unit}/kg</div>
                                    <div class="crop-location">${crop.location}</div>
                                    <p><strong>Quantity:</strong> ${crop.quantity} ${crop.unit}</p>
                                    <p><strong>Status:</strong> ${crop.status}</p>
                                    <button class="btn btn-danger" onclick="deleteCrop(${crop.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                html += '</div>';

                document.getElementById('myListingsContainer').innerHTML = html;
            } catch (error) {
                showAlert('Error loading listings: ' + error.message, 'error');
            }
        }

        async function deleteCrop(cropId) {
            if (confirm('Are you sure you want to delete this crop listing?')) {
                try {
                    const response = await fetch(`${API_BASE}/crops/${cropId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        showAlert('Crop deleted!', 'success');
                        viewMyListings();
                    } else {
                        showAlert('Failed to delete crop', 'error');
                    }
                } catch (error) {
                    showAlert('Error: ' + error.message, 'error');
                }
            }
        }

        // View My Orders (Buyer)
        async function viewMyOrders() {
            // TODO: Implement view orders for buyer
            showAlert('Orders view coming soon!', 'info');
        }

        // Admin functions
        async function viewAllUsers() {
            showAlert('User management coming soon!', 'info');
        }

        async function viewAllTransactions() {
            showAlert('Transaction management coming soon!', 'info');
        }

        async function managePrices() {
            showAlert('Price management coming soon!', 'info');
        }

        // Initialize on load
        initDashboard();
    </script>
</body>
</html>
